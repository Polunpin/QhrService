<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tencent.dao.UsersMapper">

    <resultMap id="UsersMap" type="com.tencent.model.User">
        <constructor>
            <idArg column="id" javaType="java.lang.Long" name="id"/>
            <arg column="openid" javaType="java.lang.String" name="openid"/>
            <arg column="unionid" javaType="java.lang.String" name="unionid"/>
            <arg column="mobile" javaType="java.lang.String" name="mobile"/>
            <arg column="real_name" javaType="java.lang.String" name="realName"/>
            <arg column="status" javaType="java.lang.Integer" name="status"/>
            <arg column="created_at" javaType="java.time.LocalDateTime" name="createdAt"/>
            <arg column="updated_at" javaType="java.time.LocalDateTime" name="updatedAt"/>
        </constructor>
    </resultMap>

    <sql id="User_Columns">
        id, openid, unionid, mobile, real_name, status, created_at, updated_at
    </sql>

    <select id="getById" resultMap="UsersMap" parameterType="java.lang.Long">
        SELECT <include refid="User_Columns"/>
        FROM users
        WHERE id = #{id}
    </select>

    <select id="getByOpenid" resultMap="UsersMap" parameterType="java.lang.String">
        SELECT <include refid="User_Columns"/>
        FROM users
        WHERE openid = #{openid}
    </select>

    <select id="list" parameterType="com.tencent.dto.UsersRequest">
        SELECT u.id,u.real_name AS name,u.mobile,
        COALESCE(ue.enterprises, 0) AS enterprises,
        COALESCE(m.matchCount, 0) AS matchCount,
        m.lastMatch AS lastMatch
        FROM users u
        LEFT JOIN
        (SELECT user_id, COUNT(DISTINCT enterprise_id) AS enterprises
        FROM user_enterprise_relation
        GROUP BY user_id) ue ON u.id = ue.user_id
        LEFT JOIN
        (SELECT user_id, COUNT(id) AS matchCount, MAX(created_at) AS lastMatch
        FROM match_records
        GROUP BY user_id) m ON u.id = m.user_id
        <where>
            <if test="status != null">AND status = #{status}</if>
            <if test="mobile != null and mobile != ''">AND mobile = #{mobile}</if>
            <if test="realName != null and realName != ''">AND real_name LIKE CONCAT('%', #{realName}, '%')</if>
        </where>
        and u.status = 1 ORDER BY id DESC
        <if test="offset != null and size != null">
            LIMIT #{offset}, #{size}
        </if>
    </select>

    <select id="count">
        SELECT COUNT(1)
        FROM users
        <where>
            <if test="status != null"> AND status = #{status}</if>
            <if test="mobile != null and mobile != ''"> AND mobile = #{mobile}</if>
            <if test="realName != null and realName != ''"> AND real_name LIKE CONCAT('%', #{realName}, '%')</if>
        </where>
    </select>

    <select id="listByEnterpriseId" resultMap="UsersMap">
        SELECT u.id, u.openid, u.unionid, u.mobile, u.real_name, u.status, u.created_at, u.updated_at
        FROM users u
        JOIN user_enterprise_relation r ON u.id = r.user_id
        WHERE r.enterprise_id = #{enterpriseId}
        ORDER BY u.id DESC
        <if test="offset != null and size != null">
            LIMIT #{offset}, #{size}
        </if>
    </select>

    <select id="countByEnterpriseId">
        SELECT COUNT(1)
        FROM users u
        JOIN user_enterprise_relation r ON u.id = r.user_id
        WHERE r.enterprise_id = #{enterpriseId}
    </select>

    <insert id="insert" parameterType="com.tencent.model.User">
        INSERT INTO users (openid, unionid, mobile, real_name, status)
        VALUES (#{openid}, #{unionid}, #{mobile}, #{realName}, #{status})
    </insert>

    <update id="update" parameterType="com.tencent.model.User">
        UPDATE users
        <set>
            <if test="openid != null">openid = #{openid},</if>
            <if test="unionid != null">unionid = #{unionid},</if>
            <if test="mobile != null">mobile = #{mobile},</if>
            <if test="realName != null">real_name = #{realName},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="java.lang.Long">
        DELETE FROM users WHERE id = #{id}
    </delete>

    <update id="updateStatus">
        UPDATE users SET status = #{status}
        WHERE id = #{id}
    </update>

    <select id="lastInsertId" resultType="long">
        SELECT LAST_INSERT_ID()
    </select>

</mapper>
